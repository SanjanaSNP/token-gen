name: 🔁 Refresh GitHub App Token Every 45 Min

on:
  workflow_run:
    workflows: ["🟢 Start Logic App Job"]
    types:
      - requested

jobs:
  refresh-token:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Download token flag
        uses: actions/download-artifact@v4
        with:
          name: token-flag
          path: .

      - name: Check if refresh is enabled
        id: check_flag
        run: |
          if [ -f ".token_refresh_enabled" ]; then
            echo "✅ Token refresh is enabled."
            echo "enabled=true" >> $GITHUB_OUTPUT
          else
            echo "❌ Token refresh disabled."
            echo "enabled=false" >> $GITHUB_OUTPUT
          fi

      - name: Exit if disabled
        if: steps.check_flag.outputs.enabled != 'true'
        run: exit 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install PyJWT cryptography requests

      - name: Run token generation script
        env:
          APP_ID: ${{ secrets.APP_ID }}
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
          LOGIC_APP_URL: ${{ secrets.LOGIC_APP_URL }}
        run: |
          python send_jwt.py
